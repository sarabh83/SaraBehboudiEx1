name: CI-CD Deploy

on:
  push:
    branches: [ "main" ]

env:
  APP_DIR: /var/www/sara-music-card
  PORT: "5000"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy to server
        run: |
          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            set -e
            mkdir -p $APP_DIR
            cd $APP_DIR
            if [ ! -d .git ]; then
              git clone https://github.com/${{ github.repository }} .
            else
              git pull
            fi
            command -v python3 >/dev/null 2>&1 || sudo apt-get install -y python3 python3-venv python3-pip git
            python3 -m venv venv || python -m venv venv
            . venv/bin/activate
            pip install -U pip
            [ -f requirements.txt ] && pip install -r requirements.txt || true
            pkill -f 'python3 app.py' || true
            nohup python3 app.py > app.log 2>&1 &
            echo 'Deployed OK'
          "
 
